sudo: required
dist: trusty

language: cpp

git:
    depth: 3

branches:
    only:
    - master
    - dev

matrix:
  include:
    - os: linux
      services:
        - docker
      before_install:
        - docker pull ethiy/proj.city
      script:
        - docker run ethiy/proj.city /bin/sh -c "export CC=/usr/bin/gcc; export CXX=/usr/bin/g++; cmake ../.. -DCGAL_DIR=/usr/lib/x86_64-linux-gnu/CGAL/; cmake ../..; make -j4"

    - os: linux
      services:
        - docker
      before_install:
        - docker pull ethiy/proj.city
      script:
        - docker run ethiy/proj.city /bin/sh -c "export CC=/usr/bin/clang; export CXX=/usr/bin/clang++; cmake ../.. -DCGAL_DIR=/usr/lib/x86_64-linux-gnu/CGAL/; cmake ../..; make -j4"

    - os: osx
      osx_image: xcode8
      cache:
        directories:
          - $HOME/Library/Caches/Homebrew
          - ./external
          - $HOME/3rdParty
      compiler: clang
      before_install:
        - brew update
        - brew outdated boost || brew upgrade boost
        - brew install lib3ds
        - brew install tinyxml2
        - mkdir -p 3rdParty && cd 3rdParty
        - wget https://github.com/CGAL/cgal/archive/releases/CGAL-4.10.tar.gz
        - mkdir CGAL-4.10 && tar xf CGAL-4.10.tar.gz -C CGAL-4.10 --strip-components 1 && cd CGAL-4.10
        - mkdir build && cd build
        - cmake ..
        - sudo make -j `nproc` install && sudo make install_FindCGAL
        - cd $TRAVIS_BUILD_DIR/3rdParty
        - mkdir -p PROJ && cd PROJ
        - wget http://www.kyngchaos.com/files/software/frameworks/PROJ_Framework-4.9.2-2.dmg-1.5.3.dmg
        - sudo hdiutil attach PROJ_Framework-1.5.3.dmg
        - sudo installer -package "/Volumes/PROJ Framework/PROJ Framework.pkg" -target /
        - cd $TRAVIS_BUILD_DIR/3rdParty
        - mkdir -p GEOS && cd GEOS
        - wget http://www.kyngchaos.com/files/software/frameworks/GEOS_Framework-3.6.1-1.dmg
        - sudo hdiutil attach GEOS_Framework-1.5.3.dmg
        - sudo installer -package "/Volumes/GEOS Framework/GEOS Framework.pkg" -target /
        - cd $TRAVIS_BUILD_DIR/3rdParty
        - mkdir -p UnixImageIO && cd UnixImageIO
        - wget http://www.kyngchaos.com/files/software/frameworks/UnixImageIO_Framework-1.5.3.dmg
        - sudo hdiutil attach UnixImageIO_Framework-1.5.3.dmg
        - sudo installer -package "/Volumes/UnixImageIO Framework/UnixImageIO Framework.pkg" -target /
        - cd $TRAVIS_BUILD_DIR/3rdParty
        - mkdir -p SQLite3 && cd SQLite3
        - wget http://www.kyngchaos.com/files/software/frameworks/SQLite3_Framework-3.14.1-1.dmg
        - sudo hdiutil attach SQLite3_Framework-1.5.3.dmg
        - sudo installer -package "/Volumes/SQLite3 Framework/SQLite3 Framework.pkg" -target /
        - cd $TRAVIS_BUILD_DIR/3rdParty
        - mkdir -p GDAL && cd GDAL
        - wget http://www.kyngchaos.com/files/software/frameworks/GDAL_Framework-2.1.3-1.dmg
        - sudo hdiutil attach GDAL_Framework-2.1.3-1.dmg
        - sudo installer -package "/Volumes/GDAL Complete/GDAL Complete.pkg" -target /
        - cd $TRAVIS_BUILD_DIR
        - mkdir build
        - mkdir build/darwin
      install:
        - cd build/darwin
        - cmake -DCGAL_DONT_OVERRIDE_CMAKE_FLAGS=ON ../..
      script:
        - make -j4 all
